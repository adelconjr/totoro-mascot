<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1">
    <title>Totoro</title>
    <link rel="stylesheet" href="2023-09-2023_18_style.css">
</head>
<body>
    <div id="bg">
        <p id="loading">Atualizando dialogos...</p>
        <img class="bg" src="images/2023-09-2023_totoro.png" alt="">
        <img id="rabo" src="images/rabo.png" alt="">

        <div id="starsSky"></div>

        <div class="eyes" id="left-eye"></div>
        <div class="eyes" id="right-eye"></div>
        <img id="eye1" class="eyes-img" draggable="false" src="images/olho.png" />
        <img id="eye2" class="eyes-img" draggable="false" src="images/olho.png" />
        <img id="cloud" draggable="false" src="images/nuvem.png" />

        <img id="rose" src="images/rosa.png" alt="">

        <img id="baloon" src="images/balao2.png" alt="">

        <div class="containerBalloon">
            <p id="txtBaloon"></p>
        </div>

        <!-- <div id="console"></div> -->
    </div>

    <script type="text/javascript" src="hammer.min.js"></script>

    <script>
        var hour = 0;

        var CONFIGS = {
            MORNING: "MORNING",
            AFTERNOON_1: "AFTERNOON_1",
            AFTERNOON_2: "AFTERNOON_2",
            NIGHT: "NIGHT",
        };

        function loading(op) {
            var elem = document.getElementById('loading');

            if(op) {
                elem.style.display = 'block'
            }
            else {
                elem.style.display = 'none'
            }
        }

        var bg = document.querySelector('img.bg'),
            leftEye = document.getElementById('left-eye'),
            rightEye = document.getElementById('right-eye'),
            eye1 = document.getElementById('eye1'),
            eye2 = document.getElementById('eye2'),
            indexTxt = 0
            showStars = false,
            allDialogs = []
            timeoutDialog = null;

        var dialogs = [];

        var canvas1 = {
            width: leftEye.offsetWidth,
            height: leftEye.offsetHeight,
            top: leftEye.offsetTop,
            left: leftEye.offsetLeft
        }

        canvas1.center = [canvas1.left + canvas1.width / 2, canvas1.top + canvas1.height / 2];
        canvas1.radius = canvas1.width / 2;

        var canvas2 = {
            width: rightEye.offsetWidth,
            height: rightEye.offsetHeight,
            top: rightEye.offsetTop,
            left: rightEye.offsetLeft
        }

        canvas2.center = [canvas2.left + canvas2.width / 2, canvas2.top + canvas2.height / 2];
        canvas2.radius = canvas2.width / 2;

        function limit(x, y, canvas) {
            var dist = distance([x, y], [canvas.center[0] - 5, canvas.center[1] - 5]);

            if (dist <= canvas.radius) {
                return {x: x, y: y};
            } 
            else {
                x = x - canvas.center[0] - 5;
                y = y - canvas.center[1] - 5;
                var radians = Math.atan2(y, x);
                return {
                    x: Math.cos(radians) * (canvas.radius - 5) + (canvas.center[0] - 5),
                    y: Math.sin(radians) * (canvas.radius - 5) + (canvas.center[1] - 5)
                }
            }
        }

        function distance(dot1, dot2) {
            var x1 = dot1[0],
                y1 = dot1[1],
                x2 = dot2[0],
                y2 = dot2[1];

            return Math.sqrt(Math.pow(x1 - x2, 2) + Math.pow(y1 - y2, 2));
        }

        var area = document.getElementById('bg');
        var h = new Hammer(area);

        h.get('pan').set({ direction: Hammer.DIRECTION_ALL });

        h.on('panmove', (e) => {
            hideBaloon();

            bg.src = "images/2023-09-2023_totoro.png";
            var x = e.changedPointers[0].x;
            var y = e.changedPointers[0].y;
            
            var result1 = limit(x, y, canvas1);

            eye1.style.left = result1.x + 'px';
            eye1.style.top = result1.y + 'px';

            var result2 = limit(x, y, canvas2);

            eye2.style.left = result2.x + 'px';
            eye2.style.top = result2.y + 'px';
        });

        h.on('panend', (e) => {
            bg.src = "images/2023-09-2023_totoro2.png";
            var countdownDialog = 2000;

            if(dialogs.length > 0) {
                showBaloon(dialogs[indexTxt]);

                if(dialogs[indexTxt].length > 20) {
                    countdownDialog = 3000;
                }

                if(hour >= 5 && hour < 12 && indexTxt == dialogs.length - 1) {
                    showRose();
                }

                indexTxt++;

                if(indexTxt == dialogs.length) {
                    indexTxt = 0;
                }
            }

            clearTimeout(timeoutDialog);

            timeoutDialog = setTimeout(() => {
                bg.src = "images/2023-09-2023_totoro.png";
                hideBaloon();
            }, countdownDialog);

            eye1.style.left = '125px';
            eye1.style.top = '262px';

            eye2.style.left = '215px';
            eye2.style.top = '262px';

            
        });

        function showRose() {
            var interval  = null;

            var rose = document.getElementById('rose');
            rose.classList.add('show');

            setInterval(() => {
                if(rose.offsetTop == 400) {
                    rose.style.top = `${410}px`;
                }
                else {
                    rose.style.top = `${400}px`;
                }
            }, 1000);

            rose.addEventListener('click', () => {
                rose.classList.remove('show');
            });

            setTimeout(() => {
                rose.classList.remove('show');
            }, 10000);
        }


        function animate(sheet) {
            var size = window.innerWidth;
            var direction = 'left';
            var defaultTransform = 'rotateX(190deg) rotateZ(10deg)';

            sheet.style.transform = `rotate(-130deg) ${defaultTransform}`;

            var interval1 = setInterval(() => {
                if(sheet.offsetLeft < size) {
                    var randomDistance = Math.floor(Math.random() * 40 + 10);

                    sheet.style.left = sheet.offsetLeft + randomDistance + "px";                    
                }
                else {
                    clearInterval(interval1);
                    clearInterval(interval2);
                    clearInterval(interval3);
                    document.body.removeChild(sheet);
                }
            }, 500);

            var interval3 = setInterval(() => {
                var randomTop = Math.floor(Math.random() * 20);
                sheet.style.top = sheet.offsetTop + randomTop + "px";
            }, 5000);

            var interval2 = setInterval(() => {
                if(direction == 'left') {
                    direction = 'right';
                    sheet.style.transform = `rotate(-135deg) ${defaultTransform} translateY(-10px)`;
                }
                else {
                    direction = 'left';
                    sheet.style.transform = `rotate(-125deg) ${defaultTransform}`;
                }
            }, 1000);
        }

        function draw() {
            var sheet = document.createElement('img');
            sheet.classList.add('sheet');
            sheet.src = "images/folhas.png";
            var ramdomTop = Math.floor(Math.random() * window.innerHeight + 100);
            sheet.style.top = ramdomTop + "px";

            var randomTransition = Math.floor(Math.random() * 3 + 1);

            sheet.style.transition = `${randomTransition}s all linear`;

            document.body.appendChild(sheet);
            animate(sheet);
        }

        draw();

        setTimeout(() => { draw() }, 2000);
        setTimeout(() => { draw() }, 4000);

        setInterval(draw, 5000);
        setInterval(draw, 10000);
        setInterval(draw, 12000);
        setInterval(draw, 14000);

        function cloudAnimation() {
            var cloud = document.getElementById('cloud'),
                randomTop = Math.floor(Math.random() * 200 + 20),
                interval = null;
            

            const first = () => {
                cloud.style.top = `${randomTop}px`;
                cloud.style.transition = '10s left linear';                
            }

            const animate = () => {
                cloud.style.left = `${cloud.offsetLeft + 50}px`;

                if(cloud.offsetLeft > window.innerWidth || cloud.offsetLeft > 500) {                    
                    clearInterval(interval);

                    cloud.style.transition = "none";
                    cloud.style.left = '-240px';
                    
                    setTimeout(() => {
                        first();
                        interval =  setInterval(animate, 10000);
                    }, 5000);
                }                
            }

            first();
            animate();
            interval =  setInterval(animate, 10000);
        }

        cloudAnimation();

        function showBaloon(txt) {
            var balloon = document.getElementById('baloon');
            var p = document.getElementById('txtBaloon');

            p.innerText = txt;

            balloon.style.display = 'block';
            p.style.display = 'block';
        }

        function hideBaloon() {
            var balloon = document.getElementById('baloon');
            var p = document.getElementById('txtBaloon');
            balloon.style.display = 'none';
            p.style.display = 'none';
        }


        function night() {            
            if(hour >= 18 && hour < 21) {
                dialogs = nightDialogs1
            }
            else {
                dialogs = nightDialogs2;
            }

            if(!showStars) {
                showStars = true;
                var sky = document.getElementById('starsSky');

                for(var i=0;i< 100; i++) {
                    var star = document.createElement('span');
                    star.classList.add('star');
                    var randomLeft = Math.floor(Math.random() * window.innerWidth);
                    var randomTop = Math.floor(Math.random() * 600);

                    star.style.left = `${randomLeft}px`;
                    star.style.top = `${randomTop}px`;
                    sky.appendChild(star);
                }
            }
        }

        const time = () => {
            var date = new Date();
            hour = date.getHours();

            var xhr = new XMLHttpRequest();
            xhr.open("GET", 'dialogs.json', true);

            xhr.onreadystatechange = function() {
                if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
                    console.log(this.responseText);

                    loading(false);
                    allDialogs = JSON.parse(this.responseText);

                    allDialogs.forEach((dialog) => {
                        if(hour >= dialog.period[0] && hour < dialog.period[1]) {
                            removeClasses();
                            dialogs = dialog.dialogs;

                            switch(dialog.config) {
                                default:
                                case CONFIGS.MORNING: 
                                    document.body.classList.add('day');
                                    break;

                                case CONFIGS.AFTERNOON_1: 
                                    document.body.classList.add('afternoon1');
                                    break;

                                case CONFIGS.AFTERNOON_2: 
                                    document.body.classList.add('afternoon2');
                                    break;

                                case CONFIGS.NIGHT: 
                                    document.body.classList.add('night');
                                    night();
                                    break;
                            }                    
                        }
                    
                    });
                }
            }
            xhr.send();            
        }

        function removeClasses() {
            document.body.classList.remove('day');
            document.body.classList.remove('afternoon1');
            document.body.classList.remove('afternoon2');
            document.body.classList.remove('night');
        }

        setInterval(time, 5000);

        document.body.classList.add('day');
        time();
        loading(true);

    </script>
</body>
</html>